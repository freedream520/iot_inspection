<!DOCTYPE html>
<html style="height: 100%">
<head>
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>列表组件数据设置</title>
    <link rel="stylesheet" href="/package/layui-2.2.5/css/layui.css">
    <link rel="stylesheet" href="/css/tableCreate.css">	
</head>
<body >
	<div class="layui-fluid" style="overflow:hidden"> 		
		<div class="layui-row layui-col-space20">
	   		<div class="layui-col-md12 layui-col">
	   			<form class="layui-form" action="">
	   				 <div class="layui-form-item layui-form-text" >
				     	<label class="layui-form-label">链接数据：</label>
				    	<div class="layui-input-block">
				      		<textarea name="dataInfo" placeholder="链接返回的数据" class="layui-textarea"
				      			style="height:120px">
				      		</textarea>
				   		</div>
				 	 </div>
			    	<div class="layui-form-item">
						<label class="layui-form-label">前文本选择:</label>
						<div class="layui-input-block" id="chooseListFirst">
															
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">前数据展示:</label>
						<div class="layui-input-inline">
							<input type="text" name="showListFirst"  lay-verify="" 
								placeholder="" autocomplete="off" class="layui-input"  
								value="" style="width:500px">
						</div> 
					</div>
					<div class="layui-form-item" >
						<label class="layui-form-label">后文本选择:</label>
						<div class="layui-input-block" id="chooseListSecond" >
															
						</div>
					</div>	
					<div class="layui-form-item">
						<label class="layui-form-label">后数据展示:</label>
						<div class="layui-input-inline">
							<input type="text" name="showListSecond"  lay-verify="" 
								placeholder="" autocomplete="off" class="layui-input"  
								value="" style="width:500px">
						</div> 
					</div>
					<div class="layui-form-item" >
						<label class="layui-form-label">状态字段选择:</label>
						<div class="layui-input-block" id="chooseStateField" >
															
						</div>
					</div>	
					<div class="layui-form-item">
						<label class="layui-form-label">状态字段展示:</label>
						<div class="layui-input-inline">
							<input type="text" name="showListState"  lay-verify="" 
								placeholder="" autocomplete="off" class="layui-input"  
								value="" style="width:500px">
						</div> 
					</div>																	
				</form>
			</div>
		</div>
	</div>
	
	<!-- js书写 -->
	<script type="text/javascript" src="/package/layui-2.2.5/layui.all.js"></script>
	<script type="text/javascript" src="/package/jquery-3.3.1/jquery-3.3.1.min.js"></script>
	<script type="text/javascript" src="/javaScript/universal.js"></script>	
	<script type="text/javascript">
		/**		 
		 * 初始化参数定义
		 */
		var form = layui.form;
			 
		 /**		 
		  * 初始化页面
		  */
		$(function(){
			console.log('数据链接页面初始化……');
			var listDataUrl = parent.renderData.textUrl; 
			var showListFirstInfo = '';
			var showListSecondInfo = '';
			var showListStateInfo = '';
			ajaxByGet($.trim(listDataUrl), {}, function(jsonData){
				if(jsonData != null && jsonData.state == 0){
					var data = jsonData.data;
					if(data != null && $.trim(data) != ''){
						//展示data数据信息
						$('.layui-textarea').text(JSON.stringify(data));
						
						//赋选项值
						$.each(Object.keys(data[0]), function(index, item){
							$('#chooseListFirst').append(
									'<input type="radio" lay-filter="listFirstText" ' +
									'name="listFirstText" value="' + item + '" ' +
									'title="' + item + '"> ');
							$('#chooseListSecond').append(
									'<input type="radio" lay-filter="listSecondText" ' +
									'name="listSecondText" value="' + item + '" ' +
									'title="' + item + '"> ');
							$('#chooseStateField').append(
									'<input type="radio" lay-filter="listStatus" ' +
									'name="listSecondText" value="' + item + '" ' +
									'title="' + item + '"> ');
						})								
						form.render();
						
						/*
						 * 列表radio单选事件绑定
						 */
						form.on('radio(listFirstText)',function(thisData){
							console.log('数据链接页面单选单击事件……');
							showListFirstInfo = '';
							var thisRadioValue = thisData.value;
							var tempArray = [];  
							$.each(data, function(index, item){	 
								showListFirstInfo = showListFirstInfo + ',' + item[thisRadioValue];										
							}) 
							console.log('数据链接页面单选单击后赋值展示……');
							$(this).closest('.layui-form-item').next()
								.find('input').val(showListFirstInfo.substr(1));
						})
						
						/*
						 * 列表radio单选事件绑定
						 */
						form.on('radio(listSecondText)',function(thisData){
							console.log('数据链接页面单选单击事件……');
							showListSecondInfo = '';
							var thisRadioValue = thisData.value; 
							$.each(data, function(index, item){	 
								showListSecondInfo = showListSecondInfo + ',' + item[thisRadioValue];										
							}) 
							console.log('数据链接页面单选单击后赋值展示……');
							$(this).closest('.layui-form-item').next()
								.find('input').val(showListSecondInfo.substr(1));
						})
						
						
						/*
						 * 列表状态字段的radio单选事件绑定
						 */
						form.on('radio(listStatus)', function(thisData){
							console.log('数据链接页面状态字段单选单击事件……');
							//状态值展示showListState 
							showListStateInfo = '';
							var thisRadioValue = thisData.value;
							var tempArray = [];  
							$.each(data, function(index, item){	 
								showListStateInfo = showListStateInfo + ',' + item[thisRadioValue];										
							}) 
							$(this).closest('.layui-form-item').next()
								.find('input').val(showListStateInfo.substr(1));
							
							//获取状态字段值，去重
							var statusArr = [];
							$.each(data, function(index, item){
								var tempStatus = item[thisData.value];
								if($.inArray(tempStatus, statusArr) == '-1'){
									statusArr.push(tempStatus);
								}
							})				
							
							//状态值列表展示设置
							if(statusArr.length != 0){
								$.each(statusArr, function(index, item){
									//获取html模板 		
									$('form').append(listDataHtmlTemplate(item));									
								})																
							}
							
						});
						
					}else {
						layer.msg('数据链接请求数据为空', {icon: 6});
					}
				}else{
					layer.msg('数据链接请求失败', {icon: 6});
				}							
			});
		})
		
		/**		 
		 * 获取列表前文本
		 */
		var getListFirstText = function(){
			return $('input[name=showListFirst]').val();
		} 
		 
		/**		 
		 * 获取列表后文本
		 */
		 var getListSecondText = function(){
			return $('input[name=showListSecond]').val();
		}
		
		/**		 
		 * 获取状态值文本
		 */
		var getListStateText = function(){
			return $('input[name=showListState]').val();
		}
		
		/**		 
		 * 获取设置的列表条件状态值
		 */
		var getListStatusSet = function(){
			/*这里边是返回json对象key为状态值的方法
			var listSetJson = {};
			$.each($('#div-setStatus'), function(index, item){
				var $this = $(item);
				var key = $this.find('label:last').val();
				listSetJson[key] = {
						stateValue: $this.find('div:nth-child(2)')?1:0 , 
						url: $this.find('div:nth-child(2)').val() || '', 
						color: $this.find('div:nth-child(1)').val() || ''
				}
			})
			console.log(listSetJson);
			return listSetJson;
			*/
			var listSetJson = {
					stateValue: "",
					colorState: "",
					picture: "",
					color: "",
			};		
			$.each($('.div-setStatus'), function(index, item){ 
				var $this = $(item); 
				listSetJson.colorState = $.trim(
						(listSetJson.colorState?(listSetJson.colorState + ","):'') + 
						$.trim($this.find('label:eq(1)').text())
					);
				listSetJson.picture = $.trim(
						listSetJson.picture + "," + 
						$this.find('div:eq(1)').find('input').val() || ''
					);
				listSetJson.color = $.trim(
						listSetJson.color + "," + 
						$this.find('div:eq(0)').find('input').val() || ''
					);
				var tempStateValue = $this.find('div:eq(1)').find('input').val()?"1":"0";	
				listSetJson.stateValue =$.trim(
						listSetJson.stateValue + "," + tempStateValue						
					);
				if(index == 0){
					listSetJson.picture = listSetJson.picture.substr(1);
					listSetJson.color = listSetJson.color.substr(1);
					listSetJson.stateValue = listSetJson.stateValue.substr(1);
				}
			})
			console.log(listSetJson);
			return listSetJson;
		}
		
		 /**		 
		  * 状态值展示html模板
		  */
		 var listDataHtmlTemplate = function(statusValue){
			 var componentHtml ='<div class="layui-form-item div-setStatus"> ' + 
			 						'<label class="layui-form-label">状态值 </label> ' +
									'<label class="layui-form-label label-status" > ' + 
											statusValue + '</label> ' +
									'<div class="layui-input-inline"> ' +
										'<input type="text" name="setColor"  lay-verify="" ' + 
											'placeholder="设置该数据状态下的颜色" autocomplete="off" ' + 
											'class="layui-input" value="red" > ' +
									'</div>  ' +
									'<div class="layui-input-inline"> ' + 
										'<input type="text" name="setColor"  lay-verify="" ' + 
											'placeholder="设置该数据状态下的图片链接" autocomplete="off" ' + 
											'class="layui-input" value="/picture/logo.png" > ' +
									'</div>  ' +
									'<div class="layui-input-inline"> ' + 
										'<label class="layui-form-label" style="width:180px"> ' + 
												'显示图片、颜色才设置</label> ' +
									'</div>  ' +
								'</div>  ' +
								'</div> ' ;
		 	return componentHtml;
		 }
	</script>	
</body>
</html>